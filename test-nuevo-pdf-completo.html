<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Nuevo PDF Completo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        <script>
            // Asegura que window.jspdf existe y window.jspdf.jsPDF apunta al constructor
            window.jspdf = window.jspdf || {};
            window.jspdf.jsPDF = window.jspdf.jsPDF || window.jsPDF;
        </script>
    <script src="js/pdf/cctv-pdf.js"></script>
    <style>
        .pdf-container {
            width: 794px;  /* 21cm = ~794px a 96dpi */
            min-height: 1200px;  /* Aumentamos la altura para que quepa todo */ 
            margin: 20px auto;
            padding: 38px;  /* 1cm de margen interno */
            background: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            page-break-inside: avoid;
            font-family: Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased; 
            -moz-osx-font-smoothing: grayscale; 
            color: #111827;
        }
        .test-btn {
            display: block;
            margin: 20px auto;
            padding: 15px 30px;
            background: #4369e7;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: background-color 0.2s;
        }
        .test-btn:hover {
            background: #4369e7;
        }
        .test-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div style="text-align: center; padding: 20px; background: #f8fafc; border-bottom: 2px solid #e5e7eb;">
        <h2 style="margin: 0 0 10px 0; color: #1e40af; font-size: 24px;">Prueba de Certificado Nuevo</h2>
        <p style="margin: 0 0 20px 0; color: #6b7280;">Certificado generado completamente desde cero con footer relativo</p>
        <button class="test-btn" id="pdfBtn" onclick="generateTestPDF()">üìÑ Generar y Descargar PDF</button>
    </div>
    
    <div id="pdf-container" class="pdf-container">
        <!-- Header con barra azul lateral -->
        <div style="text-align: center; border-bottom: 3px solid #4369e7; padding-bottom: 20px; margin-bottom: 30px; position: relative;">
            <div style="position: absolute; left: 0; top: 0; bottom: 0; width: 6px; background: linear-gradient(to bottom, #1e40af, #3b82f6); border-radius: 3px;"></div>
            <h1 style="font-size: 28px; font-weight: bold; color: #4369e7; margin: 0 0 10px 0; text-transform: uppercase;">
                CERTIFICADO DE MANTENIMIENTO
            </h1>
            <h2 style="font-size: 22px; color: #374151; margin: 0; font-weight: 600;">
                SISTEMA CCTV
            </h2>
        </div>

        <!-- Informaci√≥n Esencial con fondo azul -->
        <div style="margin-bottom: 30px; background: linear-gradient(135deg, #eff6ff, #dbeafe); padding: 20px; border-radius: 10px; border-left: 6px solid #1e40af; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; font-size: 16px;">
                <div style="font-weight: 600; color: #4369e7;">
                    <span style="display: block; font-size: 14px; color: #6b7280;">Fecha:</span>
                    <span style="font-size: 18px; color:#4369e7;">28 de agosto de 2025</span>
                </div>
                <div style="font-weight: 600; color: #4369e7; text-align: right;">
                    <span style="display: block; font-size: 14px; color: #6b7280;">Certificado N¬∞:</span>
                    <span style="font-size: 18px; color: #4369e7;">CCTV-TEST-2025</span>
                </div>
            </div>
        </div>

        <!-- Informaci√≥n del Cliente -->
        <div style="margin-bottom: 30px;">
            <h3 style="font-size: 16px; font-weight: bold; color: #4369e7; margin-bottom: 15px; padding: 10px 0 10px 20px; background: linear-gradient(90deg, #eff6ff, transparent); border-left: 4px solid #4369e7;">
                INFORMACI√ìN DEL CLIENTE
            </h3>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; font-size: 14px; align-items: start;">
                <div><strong>Cliente:</strong> Empresa Test S.A.</div>
                <div><strong>RUT:</strong> 12.345.678-9</div>
                <div><strong>T√©cnico:</strong> Juan P√©rez</div>
                <div><strong>Contacto:</strong> +56 9 1234 5678</div>
                <div><strong>Email:</strong> test@empresa.cl</div>
                <div style="grid-column: 1 / 4;"><strong>Direcci√≥n:</strong> Av. Principal 123, Santiago, Chile</div>
            </div>
        </div>

        <!-- Equipos Instalados -->
        <div style="margin-bottom: 30px;">
            <h3 style="font-size: 16px; font-weight: bold; color: #4369e7; margin-bottom: 15px; padding: 10px 0 10px 20px; background: linear-gradient(90deg, #eff6ff, transparent); border-left: 4px solid #4369e7;">
                EQUIPOS INSTALADOS
            </h3>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; font-size: 14px;">
                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #e2e8f0;">
                    <strong style="color: #475569;">C√°maras IP:</strong><br>
                    <span style="font-size: 24px; color: #4369e7; font-weight: bold;">8</span>
                </div>
                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #e2e8f0;">
                    <strong style="color: #475569;">C√°maras Anal√≥gicas:</strong><br>
                    <span style="font-size: 24px; color: #4369e7; font-weight: bold;">4</span>
                </div>
                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #e2e8f0;">
                    <strong style="color: #475569;">Monitores:</strong><br>
                    <span style="font-size: 24px; color: #4369e7; font-weight: bold;">2</span>
                </div>
            </div>
        </div>

        <!-- Verificaci√≥n Realizada -->
        <div style="margin-bottom: 30px;">
            <h3 style="font-size: 16px; font-weight: bold; color: #4369e7; margin-bottom: 15px; padding: 10px 0 10px 20px; background: linear-gradient(90deg, #eff6ff, transparent); border-left: 4px solid #4369e7;">
                VERIFICACI√ìN REALIZADA
            </h3>
            <div style="font-size: 14px; background: #fefefe; border-radius: 8px; border: 1px solid #e2e8f0; padding: 20px;">
                <div style="display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap: 10px; align-items:center;">
                    <div style="padding: 8px 12px; background: #dcfce7; border-radius: 6px; color: #166534; text-align: center; font-weight: 500;">
                        ‚úì C√°maras funcionando
                    </div>
                    <div style="padding: 8px 12px; background: #dcfce7; border-radius: 6px; color: #166534; text-align: center; font-weight: 500;">
                        ‚úì Grabaci√≥n activa
                    </div>
                    <div style="padding: 8px 12px; background: #dcfce7; border-radius: 6px; color: #166534; text-align: center; font-weight: 500;">
                        ‚úì Conectividad red
                    </div>
                    <div style="padding: 8px 12px; background: #dcfce7; border-radius: 6px; color: #166534; text-align: center; font-weight: 500;">
                        ‚úì Calidad imagen
                    </div>
                    <div style="padding: 8px 12px; background: #dcfce7; border-radius: 6px; color: #166534; text-align: center; font-weight: 500;">
                        ‚úì Almacenamiento
                    </div>
                    <div style="padding: 8px 12px; background: #dcfce7; border-radius: 6px; color: #166534; text-align: center; font-weight: 500;">
                        ‚úì Acceso remoto
                    </div>
                </div>
            </div>
        </div>

        <!-- Observaciones -->
        <div style="margin-bottom: 30px;">
            <h3 style="font-size: 16px; font-weight: bold; color: #1e40af; margin-bottom: 15px; padding: 10px 0 10px 20px; background: linear-gradient(90deg, #eff6ff, transparent); border-left: 4px solid #1e40af;">
                OBSERVACIONES Y RECOMENDACIONES
            </h3>
            <div style="font-size: 14px; line-height: 1.6; background: #f8fafc; padding: 20px; border-radius: 8px; border: 1px solid #e2e8f0;">
                Sistema funcionando correctamente. Se recomienda revisar mensualmente las conexiones y limpiar las c√°maras exteriores cada 3 meses.
            </div>
        </div>

        <!-- FIRMAS - DISE√ëO RELATIVO -->
        <div style="margin: 40px 0 20px 0;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 60px;">
                <div style="text-align: center;">
                    <div style="height: 100px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; border: 1px dashed #d1d5db;">
                        <div style="color: #9ca3af;">Sin firma</div>
                    </div>
                    <div style="border-top: 2px solid #374151; padding-top: 8px; font-size: 14px;">
                        <strong>T√©cnico Responsable</strong><br>
                        <span style="font-size: 12px;">Juan P√©rez</span>
                    </div>
                </div>
                <div style="text-align: center;">
                    <div style="height: 100px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; border: 1px dashed #d1d5db;">
                        <div style="color: #9ca3af;">Sin firma</div>
                    </div>
                    <div style="border-top: 2px solid #374151; padding-top: 8px; font-size: 14px;">
                        <strong>Representante Empresa</strong><br>
                        <span style="font-size: 12px;">Representante</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- FOOTER - DISE√ëO RELATIVO -->
        <div style="margin: 20px 0; text-align: center; font-size: 12px; color: #374151; border-top: 2px solid #e5e7eb; padding-top: 15px;">
            <div style="margin-bottom: 8px;">
                Generado el: 29/8/2025 | Puede validar este certificado en nuestra web usando este c√≥digo: CCTV-TEST-2025
            </div>
            <div style="font-size: 11px; color: #1f2937; line-height: 1.3;">
                üè¢ Redes y CCTV &nbsp;‚Ä¢&nbsp; üìç Mar√≠a Eugenia L√≥pez 9726, Antofagasta &nbsp;‚Ä¢&nbsp; üåê www.redesycctv.cl &nbsp;‚Ä¢&nbsp; ‚òé +56 9 630 671 69
            </div>
        </div>

    </div>

    <script>
    async function generateTestPDF() {
            const today = new Date();
            const iso = new Date(today.getTime() - today.getTimezoneOffset()*60000).toISOString().slice(0,10);

            // Crear 2 im√°genes peque√±as de evidencia (placeholders) como dataURL
            function makeEvidence(text, color) {
                const c = document.createElement('canvas');
                c.width = 600; c.height = 400;
                const ctx = c.getContext('2d');
                ctx.fillStyle = color; ctx.fillRect(0,0,c.width,c.height);
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 36px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(text, c.width/2, c.height/2);
                return c.toDataURL('image/jpeg', 0.85);
            }
            const evidenciasDemo = [
                { src: makeEvidence('Evidencia 1', '#0ea5e9') },
                { src: makeEvidence('Evidencia 2', '#64748b') },
                { src: makeEvidence('Evidencia 3', '#16a34a') }
            ];

            const formData = {
                tipo_certificado: 'cctv',
                fecha_mantenimiento: iso,
                solicitudes_cliente: 'Revisi√≥n general del sistema y verificaci√≥n de grabaciones.',
                observaciones: 'Sistema operativo. Se recomienda limpieza de c√°maras exteriores cada 3 meses.',
                // Firmas de prueba (simuladas como trazos negros en un canvas)
                firmas: { 
                    tecnico: (() => { const c=document.createElement('canvas'); c.width=320; c.height=120; const ctx=c.getContext('2d'); ctx.strokeStyle='#111'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(10,80); for(let x=10;x<300;x+=12){ ctx.lineTo(x+6, 70+Math.sin(x/10)*8);} ctx.stroke(); return c.toDataURL('image/png'); })(),
                    cliente: (() => { const c=document.createElement('canvas'); c.width=320; c.height=120; const ctx=c.getContext('2d'); ctx.strokeStyle='#111'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(20,70); for(let x=20;x<300;x+=10){ ctx.lineTo(x+5, 60+Math.cos(x/12)*7);} ctx.stroke(); return c.toDataURL('image/png'); })()
                },
                cctv: {
                    camaras_ip: 8,
                    camaras_analogicas: 4,
                    monitores: 2,
                    nvr: 'Hikvision DS-7608',
                    dvr: 'Dahua IPC-3416IA',
                    joystick: 'NKB1000',
                    // El generador ahora distribuye 4 columnas con 2 √≠tems por columna
                    checklist: [
                        'grabaciones',
                        'limpieza_camaras',
                        'fecha_hora',
                        'enfoques',
                        'configuraciones',
                        'filtros',
                        'revision_cables',
                        'revision_almacenamiento'
                    ]
                },
                evidencias: evidenciasDemo
            };

            const info = {
                cliente: { nombre: 'GyV Arriendos y Servicios Spa', rut: '76.123.456-7', contacto: '+56 9 1234 5678', email: 'anyortiz@gyvarriendos.cl' },
                instalacion: { direccion: 'Mar√≠a Eugenia L√≥pez 9726, Antofagasta' },
                tecnico: { nombre: 'Fernando Flores Basualto' }
            };

            // Logo de empresa (placeholder simple generado)
            function makeLogo() {
                const c = document.createElement('canvas');
                c.width = 500; c.height = 180;
                const ctx = c.getContext('2d');
                ctx.fillStyle = '#1e40af';
                ctx.fillRect(0,0,c.width,c.height);
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 72px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('Redes y CCTV', c.width/2, 115);
                return c.toDataURL('image/png');
            }
            const empresa = { logo_empresa: makeLogo() };
            const code = 'CCTV-TEST-2025';

            const gen = new window.CCTVPdfGenerator();
            try {
                await gen.generate({ formData, info, empresa, code, evidencias: evidenciasDemo, autoSave: true });
            } catch (err) {
                console.error('Error generando PDF:', err);
            }
        }
    </script>
</body>
</html>
